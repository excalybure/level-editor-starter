# Milestone 2 - Phase 7: Data-Driven Material System (Complete Implementation)

## 📋 Overview

**Phase**: 7 (Material System - Phase 2)  
**Duration**: ~14-17 days (estimate from plan)  
**Dependencies**: Phase 1 (T001-T016) - Minimal Material System

**Goal**: Complete the data-driven material system by eliminating all hard-coded values in PSO creation. Replace hard-coded shaders, states, input layouts, and other PSO fields with JSON-specified data.

**Reference**: See `specs/001-data-driven-material/PHASE2_IMPLEMENTATION_PLAN.md`

---

## 🎯 Phase Breakdown

### Phase 2A: Shader Information (T201-T203) — COMPLETE
**Goal**: Replace hard-coded `simple.hlsl` with JSON-specified shader files, entry points, profiles.

**Status**: 
- ✅ T201: Extend ShaderReference Struct (COMPLETED 2025-10-10)
- ✅ T202: Update MaterialParser to Extract Shader Info (COMPLETED 2025-01-08)
- ✅ T203: Update PipelineBuilder to Use Shader Info (COMPLETED 2025-10-10)

### Phase 2B: State Blocks (T204-T207)
**Goal**: Replace hard-coded D3D12 states with JSON-defined state blocks.

**Status**: 
- ✅ T204: Define State Block Structs (COMPLETED 2025-10-10)
- ⏳ T205: Create State Block Parser
- ⏳ T206: Integrate State Blocks
- ⏳ T207: Update PipelineBuilder (States)

### Phase 2C: Vertex Formats (T208-T211)
**Goal**: Replace hard-coded input layout with JSON-defined vertex formats.

**Status**: Not Started

### Phase 2D: Root Signature Integration (T214-T215)
**Goal**: Use generated root signature specs (from T013) in PSO creation.

**Status**: Not Started

### Phase 2E: Render Pass Config & Finalization (T216-T217, T212-T213)
**Goal**: Parse render passes from JSON; finalize all PSO fields.

**Status**: Not Started

---

## ✅ T203: Update PipelineBuilder to Use Shader Info — COMPLETED

**Date**: 2025-10-10  
**Status**: ✅ All tests passing (5 assertions in pipeline-builder tests, 79 in full material-system)

### Implementation Summary
- **Removed hardcoded shader paths** — Replaced `shaderPath = "shaders/simple.hlsl"` with iteration over `material.shaders`
- **Dynamic shader compilation** — For each `ShaderReference`, calls `MaterialShaderCompiler::CompileWithDefines()` with `file`, `entryPoint`, `profile` from parsed data
- **Stage-based bytecode population** — Maps compiled blobs to PSO descriptor fields based on `ShaderStage` enum (Vertex→VS, Pixel→PS, Domain→DS, Hull→HS, Geometry→GS)
- **Per-shader defines support** — Converts `shaderRef.defines` vector to map and passes to compiler; enables per-shader conditional compilation
- **Required shader validation** — Fatal error if Vertex shader missing for graphics PSO; ensures valid PSO configuration

### Atomic Functionalities Completed
1. **AF1: Test for shader info usage** — Created test with grid.hlsl material; verifies PSO compiles from material-specified shaders not hardcoded simple.hlsl
2. **AF2: Iterate material.shaders** — Replaced hardcoded shader compilation with loop over `material.shaders`; calls `CompileWithDefines` with shader-specific parameters
3. **AF3: Stage-based bytecode** — Switch statement maps `ShaderStage` enum to correct `D3D12_GRAPHICS_PIPELINE_STATE_DESC` fields (VS, PS, DS, HS, GS)
4. **AF4: Per-shader defines** — Converts `shaderRef.defines` vector to `unordered_map<string, string>` with empty values (flag-style defines); passes to compiler
5. **AF5: Missing shader validation** — Fatal error if `vsBlob` null after shader compilation; prevents invalid graphics PSO creation

### Tests Added/Updated
- Added T203 test: "PipelineBuilder compiles shaders from material shader info" using grid.hlsl
- Updated T014 tests to use vs_5_0/ps_5_0 profiles (compiler compatibility)
- Updated T201/T202 tests to use vs_5_0/ps_5_0 profiles
- All pipeline-builder tests pass (3 test cases, 5 assertions)

### Files Modified
- `src/graphics/material_system/pipeline_builder.cpp` — Replaced hardcoded shader compilation with dynamic iteration; added stage mapping, defines conversion, validation
- `tests/material_system_tests.cpp` — Added T203 test; updated shader profiles in T014, T201, T202 tests to vs_5_0/ps_5_0

### Test Results
```
unit_test_runner.exe "[pipeline-builder]"
All tests passed (5 assertions in 3 test cases)

unit_test_runner.exe "[material-system]"  
All tests passed (79 assertions in 12 test cases)
```

### Implementation Details
- **Shader Compilation Loop**: Iterates `material.shaders`, compiles each with `file`/`entry`/`profile` from ShaderReference
- **Bytecode Storage**: Stores compiled blobs in ComPtr variables (vsBlob, psBlob, dsBlob, hsBlob, gsBlob) based on stage
- **Defines Conversion**: Shader defines are flag-style (`#define IS_PREPASS`), so convert vector→map with empty string values
- **Stage Mapping**: Switch on `ShaderStage` enum to populate correct PSO descriptor field
- **Compute Shader Rejection**: Returns error if Compute stage present (not valid for graphics PSO)
- **Validation**: Fatal error if Vertex shader missing; other stages optional depending on pipeline configuration

### Notes
- Completes Phase 2A (Shader Information) — all hard-coded shader references eliminated
- PSO creation now fully data-driven for shader compilation stage
- Next: Phase 2B (State Blocks) — T204-T207 for rasterizer/depth/blend states
- Shader profile validation still enforces (vs|ps|ds|hs|gs|cs)_X_Y regex from T202
- Material-level defines not yet merged (future enhancement); currently only per-shader defines supported

---

## ✅ T202: Update MaterialParser to Extract Shader Info — COMPLETED

**Date**: 2025-01-08  
**Status**: ✅ All tests passing (56 assertions in material-parser tests, 79 in full material-system)

### Implementation Summary
- **Removed legacy string mode support** — Parser now requires inline shader objects with `file`, `entry`, `profile` fields
- **Added file path validation** — Checks shader file exists using `std::filesystem::exists()`, calls `console::fatal()` if missing
- **Added duplicate shader stage detection** — Uses `std::unordered_set<ShaderStage>` to detect duplicate stages, calls `console::fatal()` on duplicates
- **Profile regex validation** — Enforces `(vs|ps|ds|hs|gs|cs)_\d+_\d+` format
- **Default values preserved** — `entry` defaults to "main", `defines` defaults to empty vector from T201

### Atomic Functionalities Completed
1. **AF1: File validation** — Parser validates shader file exists relative to working directory
2. **AF2: Legacy mode removal** — String mode rejected with fatal error explaining new format required
3. **AF3: Duplicate detection** — Prevents multiple shaders with same stage (e.g., two "vertex" shaders)

### Tests Updated
- Updated T009, T014, T201 tests to use inline shader objects instead of string format
- Updated T010 tests (ReferenceValidator) to use inline shader objects
- Updated T015 test (MaterialSystem handle-based API) to use inline shader objects  
- Updated T016 integration test to use inline shader objects
- Converted `materials.json` project file from legacy string format to inline shader objects

### Files Modified
- `src/graphics/material_system/parser.cpp` — Added file validation, removed string mode support, added duplicate detection
- `tests/material_system_tests.cpp` — Updated 6 test cases (T009, T010, T014, T015, T016, T201) to use inline format
- `materials.json` — Converted 5 materials (standard_opaque, unlit_opaque, grid_material, wireframe, debug_normals) to inline shader format

### Test Results
```
unit_test_runner.exe "[material-parser]"
All tests passed (56 assertions in 5 test cases)

unit_test_runner.exe "[material-system]"  
All tests passed (79 assertions in 12 test cases)
```

### Validation Behavior
- **Missing file**: `console::fatal("Shader file 'path' does not exist")` — Terminates immediately
- **Legacy string**: `console::fatal("Legacy string shader references no longer supported. Shader 'X' in material 'Y' must be an object with 'file', 'profile', etc.")` — Guides migration
- **Duplicate stage**: `console::fatal("Duplicate shader stage 'vertex' in material 'mat_id'")` — Prevents ambiguous configurations
- **Invalid profile**: `console::fatal("Invalid shader profile 'X'. Must match (vs|ps|ds|hs|gs|cs)_N_M")` — Enforces DirectX shader model format

### Notes
- All project materials now use inline shader format — no legacy string references remain
- Parser is now strict: fails fast on any validation error
- Shader file paths validated before PSO building (fail-fast at load time, not render time)
- Completes 2/3 tasks in Phase 2A (Shader Information)

---

## ✅ T201: Extend ShaderReference Struct — COMPLETED

**Date**: 2025-10-10  
**Status**: ✅ All tests passing (20 assertions)

### Implementation Summary
- Extended `ShaderReference` struct with: `file`, `entryPoint`, `profile`, `defines` fields
- Parser supports both legacy string mode (`"vs": "shader_id"`) and new object mode (`"vs": {"file": "...", ...}`)
- Profile validation with regex: `(vs|ps|ds|hs|gs|cs)_\d+_\d+`
- Default values: `entryPoint` defaults to "main", `defines` defaults to empty
- Backward compatibility maintained — all existing tests pass

### Tests Added
1. `MaterialParser parses shader with all fields present` — Verifies file, entryPoint, profile, defines parsed correctly
2. `MaterialParser parses shader with missing optional fields and applies defaults` — Verifies defaults applied

### Files Modified
- `src/graphics/material_system/parser.h` — Extended ShaderReference struct
- `src/graphics/material_system/parser.cpp` — Updated shader parsing logic with validation
- `tests/material_system_tests.cpp` — Added T201 tests, fixed legacy test syntax

### Test Results
```
unit_test_runner.exe "[material-parser][T201]"
All tests passed (20 assertions in 2 test cases)

unit_test_runner.exe "[material-system]"  
All tests passed (79 assertions in 12 test cases)
```

### Notes
- Fatal error cases (missing file, invalid profile) documented but not unit tested (console::fatal terminates process)
- Legacy shader ID references still supported for gradual migration
- Completes 1/3 tasks in Phase 2A (Shader Information)

---

## ✅ T204: Define State Block Structs — COMPLETED

**Date**: 2025-10-10  
**Status**: ✅ All tests passing (85 assertions in state-blocks tests, 79 in full material-system)

### Implementation Summary
- **Created `state_blocks.h`** — Defines 5 struct types for JSON state block storage
- **All default values match D3D12** — Fields initialized to D3D12 default constants (FILL_MODE_SOLID, CULL_MODE_BACK, COMPARISON_FUNC_LESS, etc.)
- **Conversion methods** — `BlendRenderTargetState::toD3D12()` and `DepthStencilOpDesc::toD3D12()` convert to D3D12 descriptors
- **Inheritance support** — All structs have optional `base` field for state block inheritance (T205 will implement resolution)
- **Comprehensive coverage** — All state categories needed for graphics PSO: rasterizer, depth/stencil, blend, render target format

### Atomic Functionalities Completed
1. **AF1: RasterizerStateBlock struct** — 13 fields (fillMode, cullMode, frontCCW, depthBias, depthBiasClamp, slopeScaledDepthBias, depthClipEnable, multisampleEnable, antialiasedLineEnable, forcedSampleCount, conservativeRaster, base)
2. **AF2: DepthStencilStateBlock struct** — 8 fields + 2 stencil op descriptors (depthEnable, depthWriteMask, depthFunc, stencilEnable, stencilReadMask, stencilWriteMask, frontFace, backFace, base)
3. **AF3: BlendRenderTargetState struct** — Blend descriptor with toD3D12() conversion (blendEnable, logicOpEnable, srcBlend, destBlend, blendOp, srcBlendAlpha, destBlendAlpha, blendOpAlpha, logicOp, renderTargetWriteMask)
4. **AF4: BlendStateBlock struct** — Alpha-to-coverage, independent blend, array of 8 render targets (alphaToCoverageEnable, independentBlendEnable, renderTargets[8], base)
5. **AF5: RenderTargetStateBlock struct** — RT format and blend descriptors (format, blendDesc)

### Tests Added
1. `RasterizerStateBlock has correct default values` — Verifies all 11 state fields match D3D12 defaults
2. `DepthStencilStateBlock has correct default values` — Verifies depth/stencil enable, masks, comparison func, stencil ops
3. `BlendRenderTargetState has correct default values` — Verifies blend factors, ops, write mask defaults
4. `BlendStateBlock has correct default values` — Verifies alpha-to-coverage, independent blend, RT array defaults
5. `RenderTargetStateBlock has correct default values` — Verifies DXGI_FORMAT_R8G8B8A8_UNORM default, blend desc
6. `BlendRenderTargetState::toD3D12() converts to D3D12_RENDER_TARGET_BLEND_DESC` — Tests conversion accuracy
7. `DepthStencilOpDesc::toD3D12() converts to D3D12_DEPTH_STENCILOP_DESC` — Tests stencil op conversion

### Files Modified
- Created: `src/graphics/material_system/state_blocks.h` — 113 lines, 5 struct definitions
- Updated: `tests/material_system_tests.cpp` — Added `#include <graphics/material_system/state_blocks.h>`, 7 test cases with 85 assertions

### Test Results
```
unit_test_runner.exe "[state-blocks][T204]"
All tests passed (85 assertions in 7 test cases)

unit_test_runner.exe "[material-system]"  
All tests passed (79 assertions in 12 test cases)
```

### Implementation Details
- **Default values rationale**: Match D3D12 PSO defaults exactly to ensure no behavior changes when states unspecified
- **Struct organization**: Each state category is separate struct; MaterialDefinition will contain optional fields for each
- **Inheritance mechanism**: `base` field (string, optional) references another state block ID; parser will resolve inheritance chains
- **Conversion methods**: toD3D12() methods provide type-safe conversion to D3D12 descriptor structs
- **Array sizing**: BlendStateBlock has 8 render targets (D3D12_SIMULTANEOUS_RENDER_TARGET_COUNT)

### Notes
- Completes 1/4 tasks in Phase 2B (State Blocks)
- Structs provide foundation for T205 (JSON parsing) and T206 (MaterialSystem integration)
- All defaults carefully verified against D3D12 documentation to ensure correct PSO behavior
- Next: T205 will implement string→enum mappings for JSON parsing (FillMode, CullMode, ComparisonFunc, Blend factors, etc.)

---

## ⏳ Next Steps

**Phase 2B: State Blocks (T204-T207)**
- ✅ T204: Define State Block Structs — COMPLETED
- T205: Create State Block Parser — Parse state blocks from JSON to structs
- T206: Integrate State Blocks — Store state blocks in material system
- T207: Update PipelineBuilder (States) — Use state blocks instead of hardcoded D3D12 defaults

---

## 📊 Phase 2 Progress Tracker

| Task | Status | Tests | Notes |
|------|--------|-------|-------|
| T201: Extend ShaderReference Struct | ✅ Complete | 2 tests, 20 assertions | Struct extended, parser updated |
| T202: Update MaterialParser | ✅ Complete | 56 assertions (material-parser) | File validation, duplicate detection, legacy mode removed |
| T203: Update PipelineBuilder | ✅ Complete | 5 assertions (pipeline-builder) | Dynamic shader compilation from material data |
| T204: Define State Block Structs | ✅ Complete | 7 tests, 85 assertions | 5 structs with D3D12 defaults |
| T205: Create State Block Parser | ⏳ Pending | Pending | Phase 2B |
| T206: Integrate State Blocks | ⏳ Pending | Pending | Phase 2B |
| T207: Update PipelineBuilder (States) | ⏳ Pending | Pending | Phase 2B |
| T208: Define VertexFormat Structs | ⏳ Pending | Pending | Phase 2C |
| T209: Parse Vertex Formats | ⏳ Pending | Pending | Phase 2C |
| T210: Add vertexFormat to MaterialDef | ⏳ Pending | Pending | Phase 2C |
| T211: Use Vertex Format in PSO | ⏳ Pending | Pending | Phase 2C |
| T214: Build Root Signature from Spec | ⏳ Pending | Pending | Phase 2D |
| T215: Use Root Sig from Cache | ⏳ Pending | Pending | Phase 2D |
| T216: Parse Render Passes | ⏳ Pending | Pending | Phase 2E |
| T217: Generate RenderPassConfig | ⏳ Pending | Pending | Phase 2E |
| T212: Add Primitive Topology | ⏳ Pending | Pending | Phase 2E |
| T213: Sample Desc from RT State | ⏳ Pending | Pending | Phase 2E |

**Overall Progress**: 4/17 tasks complete (23.5%)

---

## 📚 References

- **Phase 2 Plan**: `specs/001-data-driven-material/PHASE2_IMPLEMENTATION_PLAN.md`
- **Phase 1 Progress**: See `PROGRESS_2.md` entries for T001-T016
- **Milestone Progress**: `PROGRESS_2.md`
