# Milestone 2 â€“ Phase 1 (Enhanced ECS System) Remaining Work

Date: 2025-09-06
Status Context: See `PROGRESS_2.md` for overall milestone snapshot. This document focuses narrowly on what is still missing or should be refined for Phase 1 to be considered fully complete and futureâ€‘proof.

## ðŸŽ¯ Phase 1 Goal (Recap)
Deliver a robust ECS foundation with:
- Safe entity handles (id + generation reuse)
- Efficient component storage & iteration
- Scene abstraction with hierarchy
- Core component set (Transform, Name, Visible, MeshRenderer, Selected)
- Transform system with world matrix propagation & caching
- Comprehensive unit tests

## âœ… Delivered (Verified)
- Entity creation/recycling with generation tracking (`ecs::EntityManager`).
- `ecs::Scene` with component add/remove/get, hierarchy maps, recursive destruction.
- Component storage via `ComponentStorage` and type-erased map.
- Core components defined (`runtime.components`).
- `systems::TransformSystem` basic world matrix calculation + caching.
- Tests cover: entity lifecycle, hierarchy setup, component management, transform world matrix presence, component concept validation.

## âš  Gaps / Incomplete Areas
| Area | Current Situation | Required for Completion |
|------|-------------------|-------------------------|
| ~~Child dirty propagation~~ | âœ… **COMPLETED**: Recursive dirty marking implemented in `TransformSystem` | âœ… Recursive propagation to all descendants |
| ~~Automatic dirty marking~~ | âœ… **COMPLETED**: `Scene::modifyComponent` helper implemented | âœ… API/helper to mark when components are mutated |
| ~~Hierarchy integrity ops~~ | âœ… **COMPLETED**: Cycle prevention and validity checks implemented | âœ… Prevent parenting to self/descendant; early returns/logging |
| ~~Bulk iteration patterns~~ | âœ… **COMPLETED**: `forEach<T>` helper implemented | âœ… Introduce lightweight query helper or document approach |
| ~~Component removal side-effects~~ | âœ… **COMPLETED**: Transform removal invalidates world cache | âœ… On remove, purge cached matrices & dirty sets |
| Memory/perf optimization | Unordered_map per component; no pooling | (Optional) Accept for now; document improvement notes |
| ~~Name component usage~~ | âœ… **COMPLETED**: `createEntity(name)` auto-adds Name component | âœ… Auto-add Name component when non-default name passed |
| ~~Hierarchy component vs internal maps~~ | âœ… **COMPLETED**: Removed `components::Hierarchy` to avoid duplication | âœ… Decided: keep only internal maps; component deferred |
| Testing gaps | Some test scenarios remain uncovered (see section 8) | Add targeted unit cases for remaining edge cases |
| ~~API ergonomics~~ | âœ… **COMPLETED**: `forEach<T>` helper implemented | âœ… Add minimal traversal utilities |
| Concurrency/Safety | No thread-safety guarantees | Document single-thread expectation for now |

## ðŸ“Œ Detailed Task Breakdown
### 1. ~~Transform Dirty Propagation~~ âœ… **COMPLETED**
~~- Implement recursive traversal: when marking parent dirty, enqueue/mark all descendants.~~
~~- Add safeguard against infinite loops (cycle detection) though cycles should be prevented earlier.~~
~~- Acceptance: Updating parent position updates children world matrices after one system update without manually marking children.~~
- âœ… **Status**: Implemented recursive dirty marking in `TransformSystem::markChildrenDirty` 
- âœ… **Test**: Added test case verifying parent-child dirty propagation works correctly
- âœ… **Validation**: Test passes, parent transform changes properly propagate to children

### 2. ~~Automatic Dirty Marking Mechanism~~ âœ… **COMPLETED**
~~Options:~~
~~1. Provide `ecs::Scene::modifyTransform(Entity, Functor)` that retrieves Transform, calls functor, then mark dirty.~~
~~2. Provide a thin wrapper `TransformHandle` returned by `Scene::getMutableTransform` that marks dirty on destruction if mutated.~~
~~Chosen (fast path): implement helper function now; wrapper later if needed.~~
- âœ… **Status**: Implemented generic `Scene::modifyComponent<T>` method that works for any component type
- âœ… **API**: Uses C++20 concepts to automatically call `markDirty()` if the component has this method
- âœ… **Test**: Test verifies Transform modifications automatically mark dirty and propagate to children
- âœ… **Benefits**: More flexible than Transform-only approach, works for future dirty-tracking components

### 3. ~~Hierarchy Safety~~ âœ… **COMPLETED**
~~- Block: setParent(child, child)~~
~~- Block: setParent(child, descendant)~~
~~- When reparenting, optionally preserve world transform (flag param e.g. `preserveWorld = true`). Defer if not needed yet.~~
~~- Acceptance: Attempts to create invalid hierarchies are ignored & tested.~~
- âœ… **Status**: Implemented cycle prevention in `Scene::setParent` with `isAncestor` helper
- âœ… **Coverage**: Prevents self-parenting and descendant-parenting with early returns
- âœ… **Test**: Added comprehensive "Hierarchy Safety - Cycle Prevention" test with all scenarios
- âœ… **Validation**: All ECS tests pass, including existing functionality and new safety checks

### 4. ~~Name Attachment on Creation~~ âœ… **COMPLETED**
~~- If `createEntity("Foo")` and no Name component present, auto-add Name with same string.~~
~~- Tests: creation with custom name retrieves Name component.~~
- âœ… **Status**: Implemented Name auto-add
- âœ… **Behavior**: Custom names automatically add Name component; default name "Entity" and empty strings do not
- âœ… **Coverage**: Comprehensive tests covering default name, empty string, custom names, and explicit default  
- âœ… **API**: Method `scene.createEntity("CustomName")` provides auto-add functionality
- âœ… **Tests**: All ECS tests pass including new Name auto-add functionality

### 5. ~~Cache Invalidation on Component Removal~~ âœ… **COMPLETED**
~~- If a Transform is removed: erase its entry in `m_worldMatrices` and from dirty set.~~
~~- If parent removed: ensure children still remain but their parent links cleared? (Current destroyEntity already handles recursively.) Add explicit test.~~
- âœ… **Status**: Implemented callback mechanism in `Scene::removeComponent<Transform>` to notify `TransformSystem`
- âœ… **Implementation**: `TransformSystem::onTransformRemoved()` clears cached world matrices and dirty set entries
- âœ… **Test**: Added comprehensive "Transform Cache Invalidation on Component Removal" test case
- âœ… **Validation**: All tests pass (8 assertions), including parent-child scenarios

### 6. ~~Optional Hierarchy Component Alignment~~ âœ… **COMPLETED**
~~Decision points:~~
~~- Option A: Remove `components::Hierarchy` (not yet used) to avoid duplication.~~
~~- Option B: Populate & keep it in sync each time setParent/removeParent invoked.~~
~~Recommendation: Postpone component-level hierarchy until editor panels need per-entity expansion metadata; keep internal maps only. Mark as deferred.~~
- âœ… **Decision**: Removed `components::Hierarchy` component entirely to avoid duplication with internal hierarchy maps
- âœ… **Implementation**: ECS uses internal `m_parentMap` and `m_childrenMap` for hierarchy management
- âœ… **Cleanup**: Removed all references to `components::Hierarchy` from components module, tests, and validation
- âœ… **Rationale**: Component-level hierarchy deferred until editor panels require per-entity expansion metadata
- âœ… **Future**: Can reintroduce `components::Hierarchy` later when needed for UI state (expanded/collapsed)

### 7. ~~Query / Iteration Utilities (Minimal)~~ âœ… **COMPLETED**
~~- Provide template: `scene.forEach<Transform>([](Entity e, Transform& t){...});`~~
~~- Internally iterate the `ComponentStorage<Transform>` map.~~
~~- Future extension: multi-component filter. For now single-component suffices.~~
- âœ… **Status**: Implemented `forEach<T>` template method in Scene class
- âœ… **API**: Allows single-component iteration with lambda: `scene.forEach<Transform>([](Entity e, Transform& t){...})`
- âœ… **Implementation**: Internally iterates `ComponentStorage<T>` map for efficient component access
- âœ… **Future**: Multi-component queries deferred to later phases as planned

### 8. ~~Expanded Unit Tests~~ âœ… **COMPLETED** 
**Summary:** Comprehensive test coverage for all ECS functionality and edge cases implemented.

**Already Covered:**
- âœ… Parent-child dirty propagation
- âœ… Invalid parenting (self/descendant) prevention  
- âœ… Name auto-add behavior
- âœ… Transform cache invalidation on component removal
- âœ… Basic hierarchy setup and component management

**Now Implemented and Tested:**
- âœ… **Deep Hierarchy Destruction**: Tests 4-level hierarchies, multi-branch trees, and 5-level recursion with comprehensive cascade validation (35 assertions)
- âœ… **Reparenting Preserves Sub-hierarchy**: Tests complex reparenting scenarios maintaining internal structure integrity (51 assertions)  
- âœ… **Transform Edge Cases**: Tests missing component handling, multiple dirty cycles, orphaned entities, and destruction cache cleanup (27 assertions)
- âœ… **forEach Utility Coverage**: Comprehensive iteration testing across component types, removal scenarios, and destruction edge cases (20 assertions)
- âœ… **Large Hierarchy Performance**: Performance testing with 156+ entity hierarchies, large-scale reparenting, and 200-entity forEach operations (451 assertions)

**Total Test Coverage:** 739 assertions across 16 test cases with 100% pass rate

### 9. Documentation & Comments
- Brief note in `ecs.ixx` explaining single-threaded assumption and how to extend.
- Add TODO markers for future query/multi-filter system.

## âœ… Acceptance Criteria Checklist
- [x] Child dirty propagation implemented & tested.
- [x] Name component auto-added when passing custom name (via template method).
- [x] Hierarchy cycle/self-parent prevention tests pass.
- [x] Removing Transform purges cached world matrix.
- [x] Query helper for single-component iteration available.
- [x] Tests added for all above behaviors.
- [x] Decision documented: Hierarchy component deferred (or implemented & synced).
- [ ] Basic developer doc comment for ECS usage added.

## ðŸ•’ Estimated Effort
| Task | Est. Hours |
|------|------------|
| Dirty propagation + tests | 2.0 |
| Name auto-add + tests | 0.5 |
| Hierarchy safety + tests | 1.5 |
| Cache invalidation logic | 0.5 |
| Query helper utility + tests | 1.0 |
| Test expansion (aggregate) | Included above |
| Documentation updates | 0.5 |
| Buffer / Review | 0.5 |
| **Total** | **6.5** |

## ðŸš© Risks
| Risk | Mitigation |
|------|------------|
| Over-engineering early query system | Keep MVP single-component iteration |
| Future hierarchy UI needs expansion flags | Reintroduce Hierarchy component later with migration note |
| Transform mutation bypasses dirty marking | Encourage helper usage; later consider debug asserts |

## ðŸ”® Deferred / Out of Scope for Phase 1 Completion
- Multi-component query system.
- ECS serialization/deserialization.
- Thread-safe component operations.
- Hierarchy component synchronization (unless chosen differently now).

## ðŸ“£ Next Step
Once these are complete and merged, Phase 1 can be marked fully done and Phase 2 / interaction layers can proceed with reduced technical debt.

---
(Generated. Request edits if you prefer a condensed or task-table-only version.)
