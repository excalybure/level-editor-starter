# M2_P4.md - Phase 4: 3D Gizmo Manipulation System

## 🎯 Phase Overview

Implement a complete 3D gizmo manipulation system that enables intuitive object transformation (translate, rotate, scale) with visual feedback. This phase builds upon the completed selection system from Phase 3 and prepares the command infrastructure for the undo/redo system in Phase 5.

**Dependencies**: 
- ✅ Phase 1: Enhanced ECS System (completed)
- ✅ Phase 2: glTF Asset Import Pipeline (completed) 
- ✅ Phase 3: Object Picking & Selection System (completed)

**Timeline**: Week 4-5 of Milestone 2

---

## 🏗️ Architecture Goals

- **ImGuizmo Integration**: Integrate ImGuizmo library with existing ImGui/D3D12 backend
- **Gizmo Operations**: Support translate, rotate, scale, and universal (combined) operations
- **Coordinate Spaces**: Support both local and world coordinate transformation modes
- **Snap-to-Grid**: Configurable snapping for precise positioning
- **Multi-Selection**: Handle multiple selected objects with unified gizmo operations
- **Command Preparation**: Create transform commands ready for undo/redo integration
- **Visual Feedback**: Provide real-time visual feedback during manipulation

---

## 📦 Implementation Tasks

### Task 1: ImGuizmo Dependency Integration
**Module**: Build system configuration  
**Complexity**: Low  
**Estimated Time**: 0.5 days

#### Atomic Functionalities:
1. **AF1.1**: Add ImGuizmo to vcpkg.json dependencies
2. **AF1.2**: Update CMakeLists.txt to link ImGuizmo library
3. **AF1.3**: Verify ImGuizmo headers are accessible in the build

#### Test Strategy:
- **Unit Test**: Verify ImGuizmo headers can be included without compilation errors
- **Integration Test**: Confirm ImGuizmo symbols link properly with D3D12 backend

#### Acceptance Criteria:
- [x] ImGuizmo compiles without errors
- [x] ImGuizmo can be included in C++ modules
- [x] Build system properly links ImGuizmo library

---

### ✅ Task 2: Core Gizmo System Module (COMPLETED)
**Module**: `editor.gizmos`  
**Complexity**: High  
**Estimated Time**: 2 days  
**Actual Implementation**: Core foundational types and interfaces

#### ✅ Atomic Functionalities Completed:
1. **✅ AF2.1**: Create GizmoOperation enum (Translate, Rotate, Scale, Universal)
2. **✅ AF2.2**: Create GizmoMode enum (Local, World)
3. **✅ AF2.3**: Create GizmoResult struct with manipulation deltas
4. **✅ AF2.4**: Implement GizmoSystem class constructor and basic properties
5. **✅ AF2.5**: Implement gizmo state management (manipulation tracking)

#### ⏭️ Deferred for Future Tasks:
6. **AF2.6**: Implement ImGuizmo setup and viewport integration
7. **AF2.7**: Implement manipulation processing and delta calculation
8. **AF2.8**: Implement selection center calculation for multi-selection
9. **AF2.9**: Implement transform delta application to selected entities

#### ✅ Test Strategy Completed:
- **Unit Tests**: 5 test cases, 44 assertions
  - ✅ Test GizmoOperation enum values and comparisons
  - ✅ Test GizmoMode enum values and comparisons  
  - ✅ Test GizmoResult default values and member assignments
  - ✅ Test GizmoSystem basic interface (operation/mode get/set)
  - ✅ Test GizmoSystem state management (begin/end/reset manipulation)
- **TDD Implementation**: Strict Red→Green→Refactor for each atomic functionality
- **Test Command**: `unit_test_runner.exe "[gizmos]"`

#### Implementation Files:
- **Module**: `src/editor/gizmos.ixx` - Complete C++23 module with exported types
- **Tests**: `tests/gizmos_tests.cpp` - Comprehensive test coverage
  - Test gizmo settings persistence (operation, mode, snap values)
  - Test visibility state management
- **Integration Tests**:
  - Test gizmo rendering with mock viewport
  - Test manipulation result processing with mock selection
  - Test multi-selection gizmo behavior

#### TDD Implementation Order:
1. **Red**: Write test for GizmoOperation enum values
2. **Green**: Implement GizmoOperation enum
3. **Red**: Write test for GizmoMode enum values  
4. **Green**: Implement GizmoMode enum
5. **Red**: Write test for GizmoResult default values and manipulation flags
6. **Green**: Implement GizmoResult struct
7. **Red**: Write test for GizmoSystem construction with SelectionManager
8. **Green**: Implement GizmoSystem constructor
9. **Red**: Write test for gizmo settings (operation, mode, snap) getters/setters
10. **Green**: Implement settings properties
11. **Red**: Write test for gizmo visibility control
12. **Green**: Implement visibility management
13. **Red**: Write test for selection center calculation with single entity
14. **Green**: Implement basic selection center calculation
15. **Red**: Write test for selection center with multiple entities
16. **Green**: Enhance selection center for multi-selection
17. **Red**: Write test for gizmo matrix calculation from selection
18. **Green**: Implement calculateGizmoMatrix method
19. **Red**: Write test for transform delta application to single entity
20. **Green**: Implement basic delta application
21. **Red**: Write test for transform delta distribution to multiple entities
22. **Green**: Implement distributeTransformation method

#### Acceptance Criteria:
- [ ] GizmoSystem integrates with SelectionManager
- [ ] All gizmo operations (translate, rotate, scale) are supported
- [ ] Local and world coordinate modes work correctly
- [ ] Snap-to-grid functionality with configurable values
- [ ] Multi-selection gizmo centers correctly
- [ ] Transform deltas apply correctly to selected entities
- [ ] Gizmo visibility can be toggled
- [ ] All unit tests pass with >90% coverage

---

### Task 3: ImGuizmo Integration Layer
**Module**: `editor.gizmos` (continued)  
**Complexity**: Medium  
**Estimated Time**: 1.5 days

#### Atomic Functionalities:
1. **AF3.1**: Implement ImGuizmo context setup with viewport matrices
2. **AF3.2**: Implement ImGuizmo coordinate space configuration
3. **AF3.3**: Implement ImGuizmo operation mode binding
4. **AF3.4**: Implement snap value configuration for ImGuizmo
5. **AF3.5**: Implement ImGuizmo manipulation detection and result extraction
6. **AF3.6**: Implement matrix decomposition for delta calculations
7. **AF3.7**: Handle ImGuizmo edge cases and validation

#### Test Strategy:
- **Unit Tests**:
  - Test matrix decomposition accuracy for transform deltas
  - Test ImGuizmo setup with various viewport configurations
  - Test snap value conversion and validation
- **Integration Tests**:
  - Test complete gizmo interaction cycle with mock input
  - Test gizmo rendering in actual viewport context
  - Test manipulation result accuracy

#### TDD Implementation Order:
1. **Red**: Write test for ImGuizmo setup with viewport matrices
2. **Green**: Implement setupImGuizmo method
3. **Red**: Write test for ImGuizmo operation mode configuration
4. **Green**: Implement operation mode binding
5. **Red**: Write test for ImGuizmo coordinate space setup
6. **Green**: Implement coordinate space configuration
7. **Red**: Write test for snap value application
8. **Green**: Implement snap configuration
9. **Red**: Write test for manipulation detection
10. **Green**: Implement manipulation processing
11. **Red**: Write test for matrix delta extraction
12. **Green**: Implement matrix decomposition
13. **Red**: Write test for edge case handling (invalid matrices, etc.)
14. **Green**: Implement validation and error handling

#### Acceptance Criteria:
- [ ] ImGuizmo renders correctly in viewport
- [ ] All operation modes (translate, rotate, scale) work
- [ ] Local/world coordinate spaces function properly
- [ ] Snap values apply correctly during manipulation
- [ ] Matrix decomposition produces accurate deltas
- [ ] Edge cases handled gracefully
- [ ] Integration tests pass

---

### Task 4: Transform Command System (Undo/Redo Preparation)
**Module**: `editor.transform_commands`  
**Complexity**: Medium  
**Estimated Time**: 1.5 days

#### Atomic Functionalities:
1. **AF4.1**: Create base Command interface for undo/redo system
2. **AF4.2**: Implement TransformEntityCommand for single entity transformations
3. **AF4.3**: Implement BatchTransformCommand for multi-entity transformations
4. **AF4.4**: Implement TransformCommandFactory for command creation
5. **AF4.5**: Implement transform capture utilities
6. **AF4.6**: Integrate commands with GizmoSystem manipulation results

#### Test Strategy:
- **Unit Tests**:
  - Test Command interface contract compliance
  - Test TransformEntityCommand execute/undo cycle
  - Test BatchTransformCommand with multiple entities
  - Test TransformCommandFactory command creation
  - Test transform capture accuracy
- **Integration Tests**:
  - Test command creation from gizmo results
  - Test command execution with actual ECS scene
  - Test undo/redo cycle maintains scene state

#### TDD Implementation Order:
1. **Red**: Write test for Command interface basic contract
2. **Green**: Implement Command interface
3. **Red**: Write test for TransformEntityCommand construction
4. **Green**: Implement TransformEntityCommand constructor
5. **Red**: Write test for TransformEntityCommand execute operation
6. **Green**: Implement execute method
7. **Red**: Write test for TransformEntityCommand undo operation
8. **Green**: Implement undo method
9. **Red**: Write test for TransformEntityCommand description
10. **Green**: Implement getDescription method
11. **Red**: Write test for BatchTransformCommand with multiple entities
12. **Green**: Implement BatchTransformCommand
13. **Red**: Write test for BatchTransformCommand execute/undo cycle
14. **Green**: Complete BatchTransformCommand implementation
15. **Red**: Write test for TransformCommandFactory command creation
16. **Green**: Implement TransformCommandFactory
17. **Red**: Write test for transform capture from ECS entities
18. **Green**: Implement captureTransforms utility
19. **Red**: Write test for command creation from GizmoResult
20. **Green**: Implement createTransformCommand method

#### Acceptance Criteria:
- [ ] Command interface supports execute/undo/description
- [ ] TransformEntityCommand handles single entity transforms
- [ ] BatchTransformCommand handles multi-entity transforms  
- [ ] TransformCommandFactory creates appropriate commands
- [ ] Commands integrate with GizmoSystem results
- [ ] Transform capture/restore maintains precision
- [ ] All command tests pass

---

### Task 5: Gizmo UI Controls
**Module**: `editor.gizmos` (UI extension)  
**Complexity**: Low  
**Estimated Time**: 1 day

#### Atomic Functionalities:
1. **AF5.1**: Create GizmoUI class for toolbar and settings
2. **AF5.2**: Implement operation mode toolbar (translate/rotate/scale buttons)
3. **AF5.3**: Implement coordinate space toggle (local/world)
4. **AF5.4**: Implement snap settings controls
5. **AF5.5**: Implement gizmo visibility toggle
6. **AF5.6**: Implement keyboard shortcuts for gizmo operations

#### Test Strategy:
- **Unit Tests**:
  - Test UI state synchronization with GizmoSystem
  - Test toolbar button state updates
  - Test settings controls validation
- **Integration Tests**:
  - Test UI controls affect gizmo behavior
  - Test keyboard shortcuts trigger correct operations
  - Test settings persistence

#### TDD Implementation Order:
1. **Red**: Write test for GizmoUI construction and basic rendering
2. **Green**: Implement GizmoUI class structure
3. **Red**: Write test for operation mode toolbar rendering
4. **Green**: Implement renderToolbar method
5. **Red**: Write test for coordinate space toggle
6. **Green**: Implement coordinate space UI controls
7. **Red**: Write test for snap settings controls
8. **Green**: Implement snap settings UI
9. **Red**: Write test for visibility toggle
10. **Green**: Implement visibility controls
11. **Red**: Write test for keyboard shortcut handling
12. **Green**: Implement keyboard shortcuts
13. **Red**: Write test for UI state synchronization
14. **Green**: Implement state sync mechanisms

#### Acceptance Criteria:
- [ ] Toolbar displays operation mode buttons (W/E/R keys)
- [ ] Coordinate space toggle works (X key)
- [ ] Snap settings are configurable via UI
- [ ] Gizmo visibility can be toggled (G key)
- [ ] UI state synchronizes with GizmoSystem
- [ ] Keyboard shortcuts function properly
- [ ] UI controls have proper visual feedback

---

### Task 6: Integration & Testing
**Module**: Cross-module integration  
**Complexity**: Medium  
**Estimated Time**: 1 day

#### Atomic Functionalities:
1. **AF6.1**: Integrate GizmoSystem with existing SelectionManager
2. **AF6.2**: Integrate GizmoSystem with viewport rendering pipeline
3. **AF6.3**: Test complete manipulation workflow (select → manipulate → apply)
4. **AF6.4**: Test multi-selection manipulation scenarios
5. **AF6.5**: Test coordinate space switching during manipulation
6. **AF6.6**: Test snap functionality with various grid sizes
7. **AF6.7**: Validate transform command generation accuracy

#### Test Strategy:
- **Integration Tests**:
  - Test complete user workflow: select objects → show gizmo → manipulate → apply transforms
  - Test multi-object selection with unified gizmo
  - Test coordinate space consistency
  - Test snap-to-grid precision
  - Test command generation from manipulations
- **End-to-End Tests**:
  - Test gizmo with loaded glTF scenes
  - Test performance with large selections
  - Test edge cases (empty selection, invalid transforms)

#### TDD Implementation Order:
1. **Red**: Write integration test for gizmo appearance on selection
2. **Green**: Implement SelectionManager integration
3. **Red**: Write test for gizmo manipulation affecting entity transforms
4. **Green**: Implement transform application integration
5. **Red**: Write test for multi-selection gizmo behavior
6. **Green**: Ensure multi-selection integration works
7. **Red**: Write test for coordinate space switching
8. **Green**: Implement coordinate space integration
9. **Red**: Write test for snap functionality
10. **Green**: Implement snap integration
11. **Red**: Write test for command generation from manipulations
12. **Green**: Implement command integration
13. **Red**: Write test for gizmo with real glTF scenes
14. **Green**: Ensure asset integration works

#### Acceptance Criteria:
- [ ] Gizmo appears when objects are selected
- [ ] Gizmo disappears when selection is cleared
- [ ] Manipulations correctly transform selected entities
- [ ] Multi-selection shows unified gizmo at selection center
- [ ] Local/world coordinate spaces work correctly
- [ ] Snap-to-grid functions with configurable precision
- [ ] Transform commands are generated for undo/redo
- [ ] System works with imported glTF scenes
- [ ] Performance is acceptable with complex selections

---

## 🧪 Testing Strategy

### Unit Test Coverage
Each atomic functionality will have dedicated unit tests following the TDD approach:
- **Gizmo Operations**: Test each operation mode (translate, rotate, scale)
- **Coordinate Spaces**: Test local vs world transformations
- **Selection Integration**: Test single and multi-selection scenarios
- **Transform Commands**: Test command creation, execution, and undo
- **UI Controls**: Test settings persistence and keyboard shortcuts

### Integration Test Scenarios
- **Complete Workflow**: Import scene → select objects → manipulate with gizmo → verify transforms
- **Multi-Selection**: Select multiple objects → manipulate → verify unified transformation
- **Coordinate Switching**: Manipulate in world space → switch to local → verify consistency
- **Snap Functionality**: Enable snap → manipulate → verify grid alignment
- **Command Generation**: Manipulate objects → verify commands created for undo/redo

### Performance Requirements
- Gizmo rendering at 60+ FPS with complex selections
- Manipulation response time < 16ms for smooth interaction
- Memory usage stays reasonable with large multi-selections
- No frame drops during continuous manipulation

---

## 📋 Deliverables Checklist

### Code Deliverables
- [ ] **editor.gizmos module**: Complete gizmo system implementation
- [ ] **editor.transform_commands module**: Transform command infrastructure
- [ ] **ImGuizmo integration**: Working integration with D3D12 backend
- [ ] **UI controls**: Toolbar and settings for gizmo operations
- [ ] **Keyboard shortcuts**: Standard 3D editor shortcuts (W/E/R/X/G)

### Test Deliverables
- [ ] **Unit tests**: >90% coverage for all gizmo functionality
- [ ] **Integration tests**: Complete workflow testing
- [ ] **Performance tests**: Frame rate and memory usage validation
- [ ] **Edge case tests**: Error handling and boundary conditions

### Documentation Deliverables
- [ ] **API documentation**: Comprehensive module documentation
- [ ] **User guide**: How to use gizmo manipulation features
- [ ] **Integration guide**: How to integrate with other editor systems

---

## 🚀 Success Criteria

### Functional Requirements
- [ ] Objects can be selected and manipulated with visual gizmos
- [ ] All transformation modes work (translate, rotate, scale, universal)
- [ ] Local and world coordinate spaces function correctly
- [ ] Snap-to-grid works with configurable precision
- [ ] Multi-selection shows unified gizmo at selection center
- [ ] Transform commands are generated for undo/redo system
- [ ] UI controls provide intuitive gizmo operation
- [ ] Keyboard shortcuts match industry standards

### Quality Requirements
- [ ] All unit tests pass with >90% code coverage
- [ ] Integration tests validate complete workflows
- [ ] Performance meets 60+ FPS requirements
- [ ] No memory leaks in manipulation cycles
- [ ] Robust error handling for edge cases
- [ ] Code follows project naming conventions and architecture

### User Experience Requirements
- [ ] Gizmo manipulation feels responsive and smooth
- [ ] Visual feedback is clear and immediate
- [ ] Keyboard shortcuts are intuitive and discoverable
- [ ] Multi-selection behavior is predictable
- [ ] Snap feedback provides clear grid alignment indication

---

## 🔄 Dependencies & Integration Points

### Input Dependencies (Required from Previous Phases)
- **SelectionManager**: For getting/setting selected entities
- **ECS Scene**: For reading/writing entity transforms
- **Viewport**: For camera matrices and screen-to-world projection
- **Transform Component**: For entity transformation data

### Output Dependencies (Provided to Future Phases)
- **Transform Commands**: For undo/redo system in Phase 5
- **Manipulation Events**: For UI responsiveness and feedback
- **Selection Center**: For UI panel focus and camera framing

### Integration Considerations
- **Performance Impact**: Gizmo rendering must not affect viewport frame rate
- **Memory Management**: Avoid memory allocations during manipulation
- **Thread Safety**: All operations must be safe for single-threaded UI context
- **Error Handling**: Graceful degradation when ImGuizmo unavailable

---

## 📈 Future Extensions

This phase provides foundation for advanced manipulation features:
- **Custom Gizmo Styles**: Alternative visual styles for different workflows
- **Constraint Systems**: Axis locks, angle constraints, distance limits
- **Advanced Snapping**: Object-to-object snapping, surface alignment
- **Animation Integration**: Keyframe manipulation through gizmos
- **Physics Integration**: Physics-aware manipulation with collision response

---

## 🎯 Phase Completion Criteria

Phase 4 is considered complete when:
1. All atomic functionalities are implemented and tested
2. Integration tests validate complete manipulation workflows  
3. Performance requirements are met
4. Code review passes quality standards
5. Documentation is complete and accurate
6. Transform commands are ready for Phase 5 undo/redo integration

The successful completion of this phase enables intuitive 3D object manipulation, bringing the level editor to professional-grade usability standards.