# Milestone 2 â€“ Phase 1 (Enhanced ECS System) Remaining Work

Date: 2025-09-06
Status Context: See `PROGRESS_2.md` for overall milestone snapshot. This document focuses narrowly on what is still missing or should be refined for Phase 1 to be considered fully complete and futureâ€‘proof.

## ðŸŽ¯ Phase 1 Goal (Recap)
Deliver a robust ECS foundation with:
- Safe entity handles (id + generation reuse)
- Efficient component storage & iteration
- Scene abstraction with hierarchy
- Core component set (Transform, Name, Visible, MeshRenderer, Selected, Hierarchy)
- Transform system with world matrix propagation & caching
- Comprehensive unit tests

## âœ… Delivered (Verified)
- Entity creation/recycling with generation tracking (`ecs::EntityManager`).
- `ecs::Scene` with component add/remove/get, hierarchy maps, recursive destruction.
- Component storage via `ComponentStorage` and type-erased map.
- Core components defined (`runtime.components`).
- `systems::TransformSystem` basic world matrix calculation + caching.
- Tests cover: entity lifecycle, hierarchy setup, component management, transform world matrix presence, component concept validation.

## âš  Gaps / Incomplete Areas
| Area | Current Situation | Required for Completion |
|------|-------------------|-------------------------|
| ~~Child dirty propagation~~ | âœ… **COMPLETED**: Recursive dirty marking implemented in `TransformSystem` | âœ… Recursive propagation to all descendants |
| ~~Automatic dirty marking~~ | âœ… **COMPLETED**: `Scene::modifyComponent` helper implemented | âœ… API/helper to mark when components are mutated |
| Hierarchy integrity ops | No cycle prevention or validity checks on `setParent` | Prevent parenting to self/descendant; early returns/logging |
| Bulk iteration patterns | No direct view/query API (e.g., iterate Transform + MeshRenderer) | Introduce lightweight query helper or document approach |
| Component removal side-effects | Removing Transform does not invalidate world cache | On remove, purge cached matrices & dirty sets |
| Memory/perf optimization | Unordered_map per component; no pooling | (Optional) Accept for now; document improvement notes |
| Name component usage | `createEntity(name)` ignores name (no auto-add) | Auto-add Name component when non-default name passed |
| Hierarchy component vs internal maps | Both `components::Hierarchy` and internal maps not synchronized | Decide: keep only internal maps or keep component and sync |
| Testing gaps | No tests for: destroy propagation of grandchildren, invalid parenting, name auto-add, transform dirty chain | Add targeted unit cases |
| API ergonomics | No `forEach<T>(lambda)` helper | Add minimal traversal utilities |
| Concurrency/Safety | No thread-safety guarantees | Document single-thread expectation for now |

## ðŸ“Œ Detailed Task Breakdown
### 1. ~~Transform Dirty Propagation~~ âœ… **COMPLETED**
~~- Implement recursive traversal: when marking parent dirty, enqueue/mark all descendants.~~
~~- Add safeguard against infinite loops (cycle detection) though cycles should be prevented earlier.~~
~~- Acceptance: Updating parent position updates children world matrices after one system update without manually marking children.~~
- âœ… **Status**: Implemented recursive dirty marking in `TransformSystem::markChildrenDirty` 
- âœ… **Test**: Added test case verifying parent-child dirty propagation works correctly
- âœ… **Validation**: Test passes, parent transform changes properly propagate to children

### 2. ~~Automatic Dirty Marking Mechanism~~ âœ… **COMPLETED**
~~Options:~~
~~1. Provide `ecs::Scene::modifyTransform(Entity, Functor)` that retrieves Transform, calls functor, then mark dirty.~~
~~2. Provide a thin wrapper `TransformHandle` returned by `Scene::getMutableTransform` that marks dirty on destruction if mutated.~~
~~Chosen (fast path): implement helper function now; wrapper later if needed.~~
- âœ… **Status**: Implemented generic `Scene::modifyComponent<T>` method that works for any component type
- âœ… **API**: Uses C++20 concepts to automatically call `markDirty()` if the component has this method
- âœ… **Test**: Test verifies Transform modifications automatically mark dirty and propagate to children
- âœ… **Benefits**: More flexible than Transform-only approach, works for future dirty-tracking components

### 3. ~~Hierarchy Safety~~ âœ… **COMPLETED**
~~- Block: setParent(child, child)~~
~~- Block: setParent(child, descendant)~~
~~- When reparenting, optionally preserve world transform (flag param e.g. `preserveWorld = true`). Defer if not needed yet.~~
~~- Acceptance: Attempts to create invalid hierarchies are ignored & tested.~~
- âœ… **Status**: Implemented cycle prevention in `Scene::setParent` with `isAncestor` helper
- âœ… **Coverage**: Prevents self-parenting and descendant-parenting with early returns
- âœ… **Test**: Added comprehensive "Hierarchy Safety - Cycle Prevention" test with all scenarios
- âœ… **Validation**: All ECS tests pass, including existing functionality and new safety checks

### 4. ~~Name Attachment on Creation~~ âœ… **COMPLETED**
~~- If `createEntity("Foo")` and no Name component present, auto-add Name with same string.~~
~~- Tests: creation with custom name retrieves Name component.~~
- âœ… **Status**: Implemented Name auto-add
- âœ… **Behavior**: Custom names automatically add Name component; default name "Entity" and empty strings do not
- âœ… **Coverage**: Comprehensive tests covering default name, empty string, custom names, and explicit default  
- âœ… **API**: Method `scene.createEntity("CustomName")` provides auto-add functionality
- âœ… **Tests**: All ECS tests pass including new Name auto-add functionality

### 5. Cache Invalidation on Component Removal
- If a Transform is removed: erase its entry in `m_worldMatrices` and from dirty set.
- If parent removed: ensure children still remain but their parent links cleared? (Current destroyEntity already handles recursively.) Add explicit test.

### 6. Optional Hierarchy Component Alignment
Decision points:
- Option A: Remove `components::Hierarchy` (not yet used) to avoid duplication.
- Option B: Populate & keep it in sync each time setParent/removeParent invoked.
Recommendation: Postpone component-level hierarchy until editor panels need per-entity expansion metadata; keep internal maps only. Mark as deferred.

### 7. Query / Iteration Utilities (Minimal)
- Provide template: `scene.forEach<Transform>([](Entity e, Transform& t){...});`
- Internally iterate the `ComponentStorage<Transform>` map.
- Future extension: multi-component filter. For now single-component suffices.

### 8. Expanded Unit Tests
Add new test sections:
- Parent change updates children world matrices.
- Invalid parenting (self / descendant) denied.
- Name auto-add behavior.
- Removing Transform invalidates world cache (subsequent get recomputes or returns identity / null defined behavior).
- Reparent with existing children maintains structure.

### 9. Documentation & Comments
- Brief note in `ecs.ixx` explaining single-threaded assumption and how to extend.
- Add TODO markers for future query/multi-filter system.

## âœ… Acceptance Criteria Checklist
- [x] Child dirty propagation implemented & tested.
- [x] Name component auto-added when passing custom name (via template method).
- [x] Hierarchy cycle/self-parent prevention tests pass.
- [ ] Removing Transform purges cached world matrix.
- [ ] Query helper for single-component iteration available.
- [ ] Tests added for all above behaviors.
- [ ] Decision documented: Hierarchy component deferred (or implemented & synced).
- [ ] Basic developer doc comment for ECS usage added.

## ðŸ•’ Estimated Effort
| Task | Est. Hours |
|------|------------|
| Dirty propagation + tests | 2.0 |
| Name auto-add + tests | 0.5 |
| Hierarchy safety + tests | 1.5 |
| Cache invalidation logic | 0.5 |
| Query helper utility + tests | 1.0 |
| Test expansion (aggregate) | Included above |
| Documentation updates | 0.5 |
| Buffer / Review | 0.5 |
| **Total** | **6.5** |

## ðŸš© Risks
| Risk | Mitigation |
|------|------------|
| Over-engineering early query system | Keep MVP single-component iteration |
| Future hierarchy UI needs expansion flags | Reintroduce Hierarchy component later with migration note |
| Transform mutation bypasses dirty marking | Encourage helper usage; later consider debug asserts |

## ðŸ”® Deferred / Out of Scope for Phase 1 Completion
- Multi-component query system.
- ECS serialization/deserialization.
- Thread-safe component operations.
- Hierarchy component synchronization (unless chosen differently now).

## ðŸ“£ Next Step
Once these are complete and merged, Phase 1 can be marked fully done and Phase 2 / interaction layers can proceed with reduced technical debt.

---
(Generated. Request edits if you prefer a condensed or task-table-only version.)
